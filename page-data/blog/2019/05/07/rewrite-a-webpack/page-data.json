{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2019/05/07/rewrite-a-webpack/","webpackCompilationHash":"0925914ec746f272ab75","result":{"data":{"markdownRemark":{"html":"<p><strong>é²è¿…è¯´: å½“æˆ‘ä»¬ä¼šç”¨ä¸€æ ·ä¸œè¥¿çš„æ—¶å€™ï¼Œå°±è¦é€‚å½“åœ°å»äº†è§£ä¸€ä¸‹è¿™ä¸ªä¸œè¥¿æ˜¯æ€ä¹ˆè¿è½¬çš„ã€‚</strong></p>\n<hr>\n<h2>ä¸€. ä»€ä¹ˆæ˜¯Webpack</h2>\n<ul>\n<li><a href=\"https://www.webpackjs.com/\">webpackçš„ä»‹ç»</a></li>\n</ul>\n<h2>äºŒ. å†™ä¸€ä¸ªç®€å•çš„Webpack</h2>\n<h3>1. çœ‹ä¸€ä¸‹Webpackçš„æµç¨‹å›¾</h3>\n<p><img src=\"https://user-gold-cdn.xitu.io/2019/5/6/16a8c1b15586952f?w=4436&#x26;h=4244&#x26;f=jpeg&#x26;s=1152684\"></p>\n<p>å½“ç„¶æˆ‘ä¸å¯èƒ½å®ç°å…¨éƒ¨åŠŸèƒ½, å› ä¸ºèƒ½åŠ›æœ‰é™, æˆ‘åªæŒ‘å‡ ä¸ªé‡è¦çš„å®ç°</p>\n<h3>2. å‡†å¤‡å·¥ä½œ</h3>\n<p>åˆ›å»ºä¸¤ä¸ªé¡¹ç›®, ä¸€ä¸ªä¸ºé¡¹ç›®<code class=\"language-text\">juejin-webpack</code>, ä¸€ä¸ªä¸ºæˆ‘ä»¬è‡ªå·±å†™çš„æ‰“åŒ…å·¥å…·, åå­—ä¸º<code class=\"language-text\">xydpack</code></p>\n<p>1)<code class=\"language-text\">juejin-webpack</code>é¡¹ç›®ä¸»å…¥å£æ–‡ä»¶å†…å®¹å’Œæ‰“åŒ…é…ç½®å†…å®¹ä¸º :</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// webpack.config.js</span>\n\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    mode <span class=\"token punctuation\">:</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n    entry <span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'src/app.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    output <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        path <span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        filename <span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> config</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// app.js</span>\n\n<span class=\"token comment\">/* \n    // moduleA.js\n        let name = 'xuyede'\n        module.exports = name\n*/</span>\n\n<span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./js/moduleA.js'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> oH1 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">)</span>\noH1<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>oH1<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>2)ä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè‡ªå·±çš„<code class=\"language-text\">xydpack</code>åŒ…<code class=\"language-text\">link</code>åˆ°æœ¬åœ°, ç„¶åå¼•å…¥åˆ°<code class=\"language-text\">juejin-webpack</code>ä¸­, å…·ä½“æ“ä½œå¦‚ä¸‹</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// 1. åœ¨xydpacké¡¹ç›®çš„ package.jsonæ–‡ä»¶ä¸­åŠ ä¸Š binå±æ€§, å¹¶é…ç½®å¯¹åº”çš„å‘½ä»¤å’Œæ‰§è¡Œæ–‡ä»¶</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"xydpack\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"version\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"main\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"license\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"MIT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"bin\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"xydpack\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"./bin/xydpack.js\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 2. åœ¨xydpacké¡¹ç›®ä¸­æ·»åŠ ç›¸åº”è·¯å¾„çš„xydpack.jsæ–‡ä»¶, å¹¶åœ¨é¡¶éƒ¨åŠ ä¸Šè¯¥æ–‡ä»¶çš„è¿è¡Œæ–¹å¼</span>\n#<span class=\"token operator\">!</span> <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>env node\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'this is xydpack'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 3. åœ¨ xydpacké¡¹ç›®çš„å‘½ä»¤è¡Œä¸Šè¾“å…¥ npm link</span>\n\n<span class=\"token comment\">// 4. åœ¨ juejin-webpacké¡¹ç›®çš„å‘½ä»¤è¡Œä¸Šè¾“å…¥ npm link xydpack</span>\n\n<span class=\"token comment\">// 5. åœ¨ juejin-webpacké¡¹ç›®çš„å‘½ä»¤è¡Œä¸Šè¾“å…¥ npx xydpackå, ä¼šè¾“å‡º this is xydpack å°±æˆåŠŸäº†</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>3. ç¼–å†™ xydpack.js</h3>\n<p>ä»ç¬¬ä¸€æ­¥çš„æµç¨‹å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡º, <code class=\"language-text\">webpack</code>æ‰“åŒ…æ–‡ä»¶çš„ç¬¬ä¸€æ­¥æ˜¯è·å–æ‰“åŒ…é…ç½®æ–‡ä»¶çš„å†…å®¹, ç„¶åå»å®ä¾‹åŒ–ä¸€ä¸ª<code class=\"language-text\">Compiler</code>ç±», å†é€šè¿‡<code class=\"language-text\">run</code>å»å¼€å¯ç¼–è¯‘, æ‰€ä»¥æˆ‘å¯ä»¥æŠŠ<code class=\"language-text\">xydpack.js</code>ä¿®æ”¹ä¸º</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\">#<span class=\"token operator\">!</span> <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>env node\n\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> Compiler <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../lib/compiler.js'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'webpack.config.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> compiler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Compiler</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\ncompiler<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ç„¶åå»ç¼–å†™<code class=\"language-text\">compiler.js</code>çš„å†…å®¹</p>\n<p>ps : ç¼–å†™<code class=\"language-text\">xydpack</code>å¯ä»¥é€šè¿‡åœ¨<code class=\"language-text\">juejin-webpack</code>é¡¹ç›®ä¸­ä½¿ç”¨<code class=\"language-text\">npx xydpack</code> å»è°ƒè¯•</p>\n<h3>4. ç¼–å†™ compiler.js</h3>\n<h5>1. Compiler</h5>\n<p>æ ¹æ®ä¸Šé¢çš„è°ƒç”¨æˆ‘ä»¬å¯ä»¥çŸ¥é“, <code class=\"language-text\">Compiler</code>ä¸ºä¸€ä¸ªç±», å¹¶ä¸”æœ‰<code class=\"language-text\">run</code>æ–¹æ³•å»å¼€å¯ç¼–è¯‘</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config <span class=\"token operator\">=</span> config\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5>2. buildModule</h5>\n<p>åœ¨æµç¨‹å›¾ä¸­æœ‰ä¸€ä¸ª<code class=\"language-text\">buildModule</code>çš„æ–¹æ³•å»å®ç°æ„å»ºæ¨¡å—çš„ä¾èµ–å’Œè·å–ä¸»å…¥å£çš„è·¯å¾„, æ‰€ä»¥æˆ‘ä»¬ä¹ŸåŠ ä¸Šè¿™ä¸ªæ–¹æ³•</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config <span class=\"token operator\">=</span> config\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entryPath <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// modulePath : æ¨¡å—è·¯å¾„ (ç»å¯¹è·¯å¾„)</span>\n        <span class=\"token comment\">// isEntry : æ˜¯å¦æ˜¯ä¸»å…¥å£</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>åœ¨<code class=\"language-text\">buildModule</code>æ–¹æ³•ä¸­, æˆ‘ä»¬éœ€è¦ä»ä¸»å…¥å£å‡ºå‘, åˆ†åˆ«è·å–æ¨¡å—çš„è·¯å¾„ä»¥åŠå¯¹åº”çš„ä»£ç å—, å¹¶æŠŠä»£ç å—ä¸­çš„<code class=\"language-text\">require</code>æ–¹æ³•æ”¹ä¸º<code class=\"language-text\">__webpack_require__</code>æ–¹æ³•</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> content\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// æ¨¡å—çš„æºä»£ç </span>\n        <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// æ¨¡å—çš„è·¯å¾„</span>\n        <span class=\"token keyword\">let</span> moduleName <span class=\"token operator\">=</span> <span class=\"token string\">'./'</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">relative</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\\\/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isEntry<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entryPath <span class=\"token operator\">=</span> moduleName\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5>3. parse</h5>\n<p>å¾—åˆ°æ¨¡å—çš„æºç å, éœ€è¦å»è§£æ,æ›¿æ¢æºç å’Œè·å–æ¨¡å—çš„ä¾èµ–é¡¹, æ‰€ä»¥æ·»åŠ ä¸€ä¸ª<code class=\"language-text\">parse</code>æ–¹æ³•å»æ“ä½œ, è€Œè§£æä»£ç éœ€è¦ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ :</p>\n<ol>\n<li>\n<p>ä½¿ç”¨ASTæŠ½è±¡è¯­æ³•æ ‘å»è§£ææºç </p>\n</li>\n<li>\n<p>éœ€è¦å‡ ä¸ªåŒ…è¾…åŠ©</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@babel/parser -&gt; æŠŠæºç ç”ŸæˆAST\n@babel/traverse -&gt; éå†ASTçš„ç»“ç‚¹\n@babel/types -&gt; æ›¿æ¢ASTçš„å†…å®¹\n@babel/generator -&gt; æ ¹æ®ASTç”Ÿæˆæ–°çš„æºç </code></pre></div>\n<p>æ³¨æ„ : <code class=\"language-text\">@babel/traverse</code>å’Œ<code class=\"language-text\">@babel/generator</code>æ˜¯<code class=\"language-text\">ES6</code>çš„åŒ…, éœ€è¦ä½¿ç”¨<code class=\"language-text\">default</code>å¯¼å‡º</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/types'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> generator <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n  <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n  <span class=\"token function\">parse</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> dirname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ç”ŸæˆAST</span>\n      <span class=\"token keyword\">let</span> ast <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// éå†ASTç»“ç‚¹</span>\n      <span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          \n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// ç”Ÿæˆæ–°çš„ä»£ç </span>\n      <span class=\"token keyword\">let</span> sourceCode <span class=\"token operator\">=</span> <span class=\"token function\">generator</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>code\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> moduleName <span class=\"token operator\">=</span> <span class=\"token string\">'./'</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">relative</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\\\/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isEntry<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entryPath <span class=\"token operator\">=</span> moduleName\n\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>moduleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>é‚£ä¹ˆå¾—åˆ°çš„<code class=\"language-text\">ast</code>æ˜¯ä»€ä¹ˆå‘¢, å¤§å®¶å¯ä»¥å»ğŸ‘‡ <a href=\"https://astexplorer.net/\">AST Explorer</a> æŸ¥çœ‹ä»£ç è§£ææˆ<code class=\"language-text\">ast</code>åæ˜¯ä»€ä¹ˆæ ·å­ã€‚</p>\n</li>\n</ol>\n<p>å½“æœ‰å‡½æ•°è°ƒç”¨çš„è¯­å¥ç±»ä¼¼<code class=\"language-text\">require()/ document.createElement()/ document.body.appendChild()</code>, ä¼šæœ‰ä¸€ä¸ª<code class=\"language-text\">CallExpression</code>çš„å±æ€§ä¿å­˜è¿™äº›ä¿¡æ¯,  æ‰€ä»¥æ¥ä¸‹æ¥è¦å¹²çš„äº‹ä¸º : </p>\n<ul>\n<li>\n<p>ä»£ç ä¸­éœ€è¦æ”¹çš„å‡½æ•°è°ƒç”¨æ˜¯<code class=\"language-text\">require</code>, æ‰€ä»¥è¦åšä¸€å±‚åˆ¤æ–­</p>\n</li>\n<li>\n<p>å¼•ç”¨çš„æ¨¡å—è·¯å¾„åŠ ä¸Šä¸»æ¨¡å—<code class=\"language-text\">path</code>çš„ç›®å½•å</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/types'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> generator <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n  <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n  <span class=\"token function\">parse</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> dirname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ç”ŸæˆAST</span>\n      <span class=\"token keyword\">let</span> ast <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// æ¨¡å—ä¾èµ–é¡¹åˆ—è¡¨</span>\n      <span class=\"token keyword\">let</span> dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token comment\">// éå†ASTç»“ç‚¹</span>\n      <span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">CallExpression</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">p</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span>node\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>callee<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'require'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token comment\">// å‡½æ•°åæ›¿æ¢</span>\n                  node<span class=\"token punctuation\">.</span>callee<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'__webpack_require__'</span>\n                  <span class=\"token comment\">// è·¯å¾„æ›¿æ¢</span>\n                  <span class=\"token keyword\">let</span> modulePath <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value\n                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">extname</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                      <span class=\"token comment\">// require('./js/moduleA')</span>\n                      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ : </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>modulePath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> , æ£€æŸ¥æ˜¯å¦åŠ ä¸Šæ­£ç¡®çš„æ–‡ä»¶åç¼€`</span></span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">}</span>\n                  modulePath <span class=\"token operator\">=</span> <span class=\"token string\">'./'</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>dirname<span class=\"token punctuation\">,</span> modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\\\/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n                  node<span class=\"token punctuation\">.</span>arguments <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">.</span><span class=\"token function\">stringLiteral</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n                  <span class=\"token comment\">// ä¿å­˜æ¨¡å—ä¾èµ–é¡¹</span>\n                  dependencies<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// ç”Ÿæˆæ–°çš„ä»£ç </span>\n      <span class=\"token keyword\">let</span> sourceCode <span class=\"token operator\">=</span> <span class=\"token function\">generator</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>code\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> \n          sourceCode<span class=\"token punctuation\">,</span> dependencies\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> moduleName <span class=\"token operator\">=</span> <span class=\"token string\">'./'</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">relative</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\\\/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isEntry<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entryPath <span class=\"token operator\">=</span> moduleName\n\n      <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> sourceCode<span class=\"token punctuation\">,</span> dependencies <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>moduleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>é€’å½’è·å–æ‰€æœ‰çš„æ¨¡å—ä¾èµ–, å¹¶ä¿å­˜æ‰€æœ‰çš„è·¯å¾„ä¸ä¾èµ–çš„æ¨¡å—</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/types'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> generator <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">parse</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> dirname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSource</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> moduleName <span class=\"token operator\">=</span> <span class=\"token string\">'./'</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">relative</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\\\/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isEntry<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>entryPath <span class=\"token operator\">=</span> moduleName\n\n        <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> sourceCode<span class=\"token punctuation\">,</span> dependencies <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>moduleName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">[</span>moduleName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>sourceCode<span class=\"token punctuation\">)</span>\n\n        dependencies<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h5>4. emit</h5>\n<p>åœ¨è·å–äº†æ‰€æœ‰çš„æ¨¡å—ä¾èµ–å…³ç³»å’Œä¸»å…¥å£å, æ¥ä¸‹æ¥è¦æŠŠæ•°æ®æ’å…¥æ¨¡æ¿å¹¶å†™å…¥é…ç½®é¡¹ä¸­çš„<code class=\"language-text\">output.path</code></p>\n<p>å› ä¸ºéœ€è¦ä¸€ä¸ªæ¨¡æ¿, æ‰€ä»¥å€Ÿç”¨ä¸€ä¸‹<code class=\"language-text\">webpack</code>çš„æ¨¡æ¿, ä½¿ç”¨<code class=\"language-text\">EJS</code>å»ç”Ÿæˆæ¨¡æ¿, ä¸äº†è§£<code class=\"language-text\">EJS</code>çš„ç‚¹ ğŸ‘‡ <a href=\"https://ejs.bootcss.com/\">è¿™é‡Œ</a> æ¨¡æ¿çš„å†…å®¹ä¸º : </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// lib/template.ejs</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> installedModules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  \n    <span class=\"token keyword\">function</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">moduleId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  \n      <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        i<span class=\"token punctuation\">:</span> moduleId<span class=\"token punctuation\">,</span>\n        l<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        exports<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  \n      modules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span> module<span class=\"token punctuation\">,</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span> __webpack_require__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      module<span class=\"token punctuation\">.</span>l <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  \n    <span class=\"token keyword\">return</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span>__webpack_require__<span class=\"token punctuation\">.</span>s <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;%-entryPath%>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> key <span class=\"token keyword\">in</span> modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">%</span><span class=\"token operator\">></span>\n        <span class=\"token string\">\"&lt;%-key%>\"</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">module<span class=\"token punctuation\">,</span> exports<span class=\"token punctuation\">,</span> __webpack_require__</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token operator\">-</span>modules<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token operator\">%</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token punctuation\">}</span><span class=\"token operator\">%</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ä¸‹é¢æˆ‘ä»¬ç¼–å†™<code class=\"language-text\">emit</code>å‡½æ•°</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/types'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> generator <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> ejs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">parse</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> dirname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">emit</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> modules<span class=\"token punctuation\">,</span> entryPath <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n        <span class=\"token keyword\">const</span> outputPath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> filePath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>outputPath<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>filename<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readdirSync</span><span class=\"token punctuation\">(</span>outputPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span>outputPath<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        ejs<span class=\"token punctuation\">.</span><span class=\"token function\">renderFile</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'template.ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> modules<span class=\"token punctuation\">,</span> entryPath <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">code</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entry <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildModule</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>å¦‚æœå†™åˆ°è¿™, åœ¨<code class=\"language-text\">juejin-webpack</code>é¡¹ç›®é‡Œè¾“å…¥<code class=\"language-text\">npx xydpack</code>å°±ä¼šç”Ÿæˆä¸€ä¸ª<code class=\"language-text\">dist</code>ç›®å½•, é‡Œé¢æœ‰ä¸€ä¸ª<code class=\"language-text\">bundle.js</code>æ–‡ä»¶, å¯è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ğŸ‘‡ <a href=\"https://codepen.io/xuyede/pen/eamQJd\">æ¼”ç¤º</a></p>\n<h2>ä¸‰. åŠ ä¸Š loader</h2>\n<p>ç»è¿‡äºŒä¹‹å, åªæ˜¯å•çº¯åœ°è½¬äº†ä¸€ä¸‹ä»£ç , å¥½åƒæ²¡å•¥æ„ä¹‰~</p>\n<p>æ‰€ä»¥æˆ‘ä»¬è¦åŠ ä¸Š<code class=\"language-text\">loader</code>, å¯¹<code class=\"language-text\">loader</code>ä¸ç†Ÿæ‚‰çš„ç‚¹ğŸ‘‡ <a href=\"https://www.webpackjs.com/contribute/writing-a-loader/\">è¿™é‡Œ</a> å› ä¸ºæ˜¯æ‰‹å†™å˜›, æ‰€ä»¥æˆ‘ä»¬<code class=\"language-text\">loader</code>ä¹Ÿè‡ªå·±å†™ä¸€ä¸‹</p>\n<p>æ³¨æ„ : å› ä¸ºè¿™ä¸ªä¸œè¥¿ç›¸å½“ç®€æ˜“, æ‰€ä»¥åªèƒ½ç©ä¸€ä¸‹æ ·å¼çš„<code class=\"language-text\">loader</code>, å…¶ä»–çš„ç©ä¸äº†,   æ‰€ä»¥åªæ¼”ç¤ºå†™ä¸€ä¸‹æ ·å¼çš„<code class=\"language-text\">loader</code></p>\n<h4>1. æ ·å¼çš„loader</h4>\n<p>æˆ‘ä¸ªäººä¹ æƒ¯ä½¿ç”¨<code class=\"language-text\">stylus</code>å»ç¼–å†™æ ·å¼, æ‰€ä»¥æ ·å¼å°±å†™<code class=\"language-text\">stylus-loader</code>å’Œ<code class=\"language-text\">style-loader</code></p>\n<p>é¦–å…ˆ, åœ¨é…ç½®é¡¹ä¸ŠåŠ ä¸Š<code class=\"language-text\">loader</code>, ç„¶ååœ¨<code class=\"language-text\">app.js</code>ä¸­å¼•å…¥<code class=\"language-text\">init.styl</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'./'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    mode <span class=\"token punctuation\">:</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n    entry <span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'src/app.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    output <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        path <span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        filename <span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    module <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        rules <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                test <span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.styl(us)?$/</span><span class=\"token punctuation\">,</span>\n                use <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                    path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'loaders'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'style-loader.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'loaders'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'stylus-loader.js'</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> config\n<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n<span class=\"token comment\">// app.js</span>\n\n<span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./js/moduleA.js'</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./style/init.styl'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> oH1 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">)</span>\noH1<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name\ndocument<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>oH1<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª<code class=\"language-text\">loaders</code>ç›®å½•å»ç¼–å†™æˆ‘ä»¬çš„<code class=\"language-text\">loader</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// stylus-loader</span>\n\n<span class=\"token keyword\">const</span> stylus <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stylus'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">loader</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> css <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n    stylus<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            css <span class=\"token operator\">=</span> data\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> css\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> loader\n<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n<span class=\"token comment\">// style-loader</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">loader</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> script <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n        let style = document.createElement('style')\n        style.innerHTML = </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n        document.body.appendChild(style)\n    `</span></span>\n    <span class=\"token keyword\">return</span> script\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> loader</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><code class=\"language-text\">loader</code>æ˜¯åœ¨è¯»å–æ–‡ä»¶çš„æ—¶å€™è¿›è¡Œæ“ä½œçš„, å› æ­¤ä¿®æ”¹<code class=\"language-text\">compiler.js</code>, åœ¨<code class=\"language-text\">getSource</code>å‡½æ•°åŠ ä¸Šå¯¹åº”çš„æ“ä½œ</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/types'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> generator <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default\n<span class=\"token keyword\">const</span> ejs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Compiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">getSource</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> rules <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>module<span class=\"token punctuation\">.</span>rules\n            <span class=\"token keyword\">let</span> content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> rules<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> test<span class=\"token punctuation\">,</span> use <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> rules<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n                <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> use<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span>\n\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>modulePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// é€’å½’å¤„ç†æ‰€æœ‰loader</span>\n                    <span class=\"token keyword\">function</span> <span class=\"token function\">loopLoader</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">let</span> loader <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span>use<span class=\"token punctuation\">[</span>len<span class=\"token operator\">--</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                        content <span class=\"token operator\">=</span> <span class=\"token function\">loader</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">)</span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token function\">loopLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token function\">loopLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">return</span> content\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`è·å–æ•°æ®é”™è¯¯ : </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>modulePath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">parse</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source<span class=\"token punctuation\">,</span> dirname</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">buildModule</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">modulePath<span class=\"token punctuation\">,</span> isEntry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">emit</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n    <span class=\"token function\">run</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">//... }</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Compiler</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ç„¶åè¿è¡Œ<code class=\"language-text\">npx xydpack</code>æ‰“åŒ…, ä¼šæ·»åŠ ä¸€æ®µè¿™æ ·çš„ä»£ç </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token string\">\"./src/style/init.styl\"</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">module<span class=\"token punctuation\">,</span> exports<span class=\"token punctuation\">,</span> __webpack_require__</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"let style = document.createElement('style');\\nstyle.innerHTML = \\\"* {\\\\n  padding: 0;\\\\n  margin: 0;\\\\n}\\\\nbody {\\\\n  color: #f40;\\\\n}\\\\n\\\";\\ndocument.head.appendChild(style);\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ç„¶åè¿è¡Œå°±å¯ä»¥äº†, <a href=\"https://codepen.io/xuyede/pen/EzaOjW\">æ¼”ç¤º</a></p>\n<h4>*2. è„šæœ¬çš„loader</h4>\n<p>è„šæœ¬çš„<code class=\"language-text\">loader</code>, ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯<code class=\"language-text\">babel-loader</code>, æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª<code class=\"language-text\">babel-loader</code>, ä½†æ˜¯éœ€è¦ä½¿ç”¨<code class=\"language-text\">webpack</code>å»æ‰“åŒ…, ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸º</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// webpack.config.js</span>\n\nresolveLoader <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    modules <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'node_modules'</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> <span class=\"token string\">'loaders'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\nmodule <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    rules <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            test <span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.js$/</span><span class=\"token punctuation\">,</span>\n            use <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                loader <span class=\"token punctuation\">:</span> <span class=\"token string\">'babel-loader'</span><span class=\"token punctuation\">,</span>\n                options <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n                    presets <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">'@babel/preset-env'</span>\n                    <span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ä½¿ç”¨<code class=\"language-text\">babel</code>éœ€è¦ä¸‰ä¸ªåŒ…: <code class=\"language-text\">@babel/core | @babel/preset-env | loader-utils</code>å®‰è£…å, ç„¶åç¼–å†™<code class=\"language-text\">babel-loader</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber 0\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> loaderUtils <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'loader-utils'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">loader</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">source</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> options <span class=\"token operator\">=</span> loaderUtils<span class=\"token punctuation\">.</span><span class=\"token function\">getOptions</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> cb <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">async</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    babel<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> \n        <span class=\"token operator\">...</span>options<span class=\"token punctuation\">,</span>\n        sourceMap <span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        filename <span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>resourcePath<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// é”™è¯¯, è¿”å›çš„å€¼, sourceMapçš„å†…å®¹</span>\n        <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> loader</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>ç„¶åä½¿ç”¨<code class=\"language-text\">webpack</code>æ‰“åŒ…å°±è¡Œäº†</p>\n<h2>å››. æ€»ç»“</h2>\n<p>åˆ°è¿™é‡Œ, æˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚çŒœä¸€ä¸‹<code class=\"language-text\">webpack</code>çš„è¿ä½œæµç¨‹æ˜¯è¿™æ ·çš„ :</p>\n<ol>\n<li>è·å–é…ç½®å‚æ•°</li>\n<li>å®ä¾‹åŒ–Compiler, é€šè¿‡runæ–¹æ³•å¼€å¯ç¼–è¯‘</li>\n<li>æ ¹æ®å…¥å£æ–‡ä»¶, åˆ›å»ºä¾èµ–é¡¹, å¹¶é€’å½’è·å–æ‰€æœ‰æ¨¡å—çš„ä¾èµ–æ¨¡å—</li>\n<li>é€šè¿‡loaderå»è§£æåŒ¹é…åˆ°çš„æ¨¡å—</li>\n<li>è·å–æ¨¡æ¿, æŠŠè§£æå¥½çš„æ•°æ®å¥—è¿›ä¸åŒçš„æ¨¡æ¿</li>\n<li>è¾“å‡ºæ–‡ä»¶åˆ°æŒ‡å®šè·¯å¾„</li>\n</ol>\n<p>æ³¨æ„ : æˆ‘è¿™ä¸ªåªæ˜¯è‡ªå·±é—¹ç€ç©çš„, è¦å­¦<code class=\"language-text\">webpack</code>, ç‚¹ <a href=\"https://www.webpackjs.com/\">è¿™é‡Œ</a> </p>","frontmatter":{"mainTitle":"å†™ä¸€ä¸ª webpack æ€ä¹ˆæ · â“â”â“â”","date":"07 May, 2019","cover_image":{"publicURL":"/static/webpack-362a5f580df72a6b4064d0c7d6b91811.jpg"}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2019/05/07/rewrite-a-webpack/"}}}