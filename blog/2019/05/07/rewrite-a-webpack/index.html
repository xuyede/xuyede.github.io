<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.bbd61d01f8baf1b85265.css">*{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Hiragino Sans GB,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Open Sans,Droid Sans,Microsoft YaHei,WenQuanYi Micro Hei,Helvetica Neue,Tahoma,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;-webkit-transition:max-width .5s,opacity .5s,width .5s,height .5s;transition:max-width .5s,opacity .5s,width .5s,height .5s}@media (max-width:1280px){#header .header__wrapper{max-width:768px}#header .header__link span{font-size:18px}.xyd-content{max-width:768px;margin:0 auto}}@media (max-width:415px){.blog__list p{font-size:14px!important}.newBlog__wrap{flex-flow:column nowrap}.newBlog__img{width:100%!important}.newBlog__description{margin-left:0!important;margin-top:10px}.poster{height:200px!important}.poster span{line-height:200px!important}.blog__list li a{flex-flow:column-reverse nowrap;align-items:flex-start!important}.blog__list li a>:nth-child(2){width:100%!important;margin-bottom:10px}}code[class*=language-],pre[class*=language-]{color:#fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#121212}:not(pre)>code[class*=language-]{padding:.3em .4em;margin:0 .2em;border-radius:.3em;font-size:.8em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#88c6be}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#8dc891}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#c684c1}.token.class-name,.token.function{color:#efbd54}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.gatsby-highlight pre[class*=language-]{background-color:#000;margin:0;padding:0;overflow:initial;float:left;min-width:100%;font-size:16px}.gatsby-highlight pre[class*=language-] code span{line-height:16px}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.8em}.gatsby-highlight{position:relative;background-color:#000;color:#ccc;border-radius:.3em;margin:.5em 0;padding:1em;overflow:auto}.gatsby-highlight[data-language]:before{position:absolute;top:0;right:20px;padding:3px 10px;font-size:12px;text-align:right;color:#444;font-weight:700;letter-spacing:.8px;text-transform:uppercase;border-radius:0 0 5px 5px;background:#ddd;z-index:1}.gatsby-highlight[data-language=javascript]:before,.gatsby-highlight[data-language=js]:before{content:"js";background:#f7df1e}.gatsby-highlight[data-language=ts]:before,.gatsby-highlight[data-language=typescript]:before{content:"ts";background:#f7df1e}.gatsby-highlight[data-language=jsx]:before{content:"jsx";background:#f7df1e}.gatsby-highlight pre[class*=language-].line-numbers{padding:0 0 0 2.8em;overflow:initial}.header{position:fixed;top:0;left:0;width:100%;height:72px;background-color:#202124;z-index:10;box-shadow:0 2px 4px rgba(0,0,0,.5)}.header__wrapper{max-width:1060px;margin:0 auto;height:100%;justify-content:space-between;padding:0 10px}.header__link,.header__wrapper{display:flex;align-items:center}.header__link{text-decoration:none}.header__link span{color:#fff;font-size:23px}.header .main__img{width:30px;background-size:30px 30px;margin:0 1rem 0 0}.header__menu{cursor:pointer;position:relative}.header__menu span{display:block;width:28px;height:3px;background-color:#ccc}.header__menu>:nth-child(2){margin:5px 0}.header__menu:after,.header__menu:before{-webkit-transition:all .3s;transition:all .3s;content:"";position:absolute;left:50%;top:50%;width:28px;height:3px;background-color:#ccc;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}.header__menu.open{cursor:pointer}.header__menu.open span{background-color:transparent}.header__menu.open:before{-webkit-transform:translate(-50%,-50%) rotate(-45deg);transform:translate(-50%,-50%) rotate(-45deg)}.header__menu.open:after{-webkit-transform:translate(-50%,-50%) rotate(45deg);transform:translate(-50%,-50%) rotate(45deg)}.header__nav{position:fixed;top:72px;left:0;right:0;bottom:0;background-color:#202124;display:flex;justify-content:center;align-items:center;pointer-events:none;opacity:0;z-index:10}.header__nav ul{margin:0;padding:0;list-style:none}.header__nav ul li{min-width:100px;text-align:center;margin:30px 0;color:#999;cursor:pointer}.header__nav ul li a{text-decoration:none;color:#999}.header__nav ul li a:hover{color:#fff}.header__nav.open{opacity:1;pointer-events:auto}.back2Top{position:fixed;right:3%;bottom:10%;width:50px;height:50px;text-align:center;line-height:50px;border-radius:50%;overflow:hidden;cursor:pointer}.back2Top__btn{width:100%;height:100%;background-color:#333}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,html section,main,menu,nav,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#fff}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll;scroll-behavior:smooth}*,:after,:before{box-sizing:inherit}body{color:#fefefe;background-color:#202124;font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}main{margin-top:82px}main.__content p{font-size:16px;color:#888;text-align:left}main.__content p a{display:block;width:100%;color:#f80;text-align:center}main.__content ul{font-size:16px}main.__content li a{-webkit-text-decoration-line:underline;text-decoration-line:underline;color:#f80}.blog{position:relative}.blog__list{list-style:none;margin:0;padding:none}.blog__list li{margin-bottom:40px}.blog__list li a{text-decoration:none;color:#999;display:flex;justify-content:space-between;align-items:center;padding:20px;box-sizing:border-box;box-shadow:0 0 5px 2px #111}.blog__list li a>:first-child{display:flex;flex-flow:column nowrap;justify-content:space-around}.blog__list li a>:first-child>:first-child{color:#fff;font-size:1.66667vw}.blog__list li a>:first-child>:nth-child(2),.blog__list li a>:first-child>:nth-child(3){color:#999;font-size:1.11111vw}.blog__list li a>:nth-child(2){width:30%}.blog__list li a>:nth-child(2) img{width:100%;margin:0}.poster{position:relative;width:100%;height:400px}.poster span{display:inline-block;width:100%;height:100%;color:#ccc;font-size:14.28571vw;letter-spacing:2px;text-align:center;line-height:400px;background:url(http://119.23.54.204/static/xyd_image/global/mask.jpg) 50% 50%/cover;-webkit-text-fill-color:transparent;-webkit-background-clip:text;-webkit-animation:move 30s linear infinite;animation:move 30s linear infinite;font-weight:bolder}@-webkit-keyframes move{0%{background-position:100% 0}50%{background-position:0 100%}to{background-position:100% 0}}@keyframes move{0%{background-position:100% 0}50%{background-position:0 100%}to{background-position:100% 0}}.newBlog{width:100%}.newBlog>a{display:block;width:100%;height:100%;text-decoration:none;color:#fff}.newBlog__wrap{width:100%;height:100%;display:flex;justify-content:center;align-items:center}.newBlog__img{width:30%}.newBlog__img img{width:100%;margin:0}.newBlog__description{margin-left:30px;display:flex;flex-flow:column nowrap;justify-content:space-around;max-width:800px}.newBlog__description>:nth-child(2){font-size:16px}.newBlog__description>:nth-child(3){font-size:14px;color:#ccc}.lab{position:relative}.lab__browser>p,.lab__h5>p{font-size:40px;color:#999}.lab__browser>ul,.lab__h5>ul{list-style:none;margin:0}.lab__browser>ul li,.lab__h5>ul li{cursor:pointer}</style><meta name="generator" content="Gatsby 2.9.4"/><title data-react-helmet="true">写一个 webpack 怎么样 ❓❔❓❔ | 博客 | 老古董</title><meta data-react-helmet="true" name="description" content="分享一些自认为懂了的事情"/><meta data-react-helmet="true" property="og:title" content="写一个 webpack 怎么样 ❓❔❓❔ | 博客"/><meta data-react-helmet="true" property="og:description" content="分享一些自认为懂了的事情"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@xuyede"/><meta data-react-helmet="true" name="twitter:title" content="写一个 webpack 怎么样 ❓❔❓❔ | 博客"/><meta data-react-helmet="true" name="twitter:description" content="分享一些自认为懂了的事情"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=6fe7c46e0b1948f15ccafefff99a0cc8"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-7d9641c02123281eb66f.js"/><link as="script" rel="preload" href="/1-1708d7373d1b726d8c3a.js"/><link as="script" rel="preload" href="/app-a702b083f54a54c055ec.js"/><link as="script" rel="preload" href="/styles-3707068c25adbcad7d92.js"/><link as="script" rel="preload" href="/webpack-runtime-0b572f9ac9ad8fc9d343.js"/><link as="fetch" rel="preload" href="/page-data\blog\2019\05\07\rewrite-a-webpack\page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div style="position:relative;margin:0 auto;max-width:1060px;padding:0px 1.0875rem 1.45rem;padding-top:0"><header id="header" class="header"><div class="header__wrapper"><a class="header__link" href="/"><img class="main__img" src="data:image/png;base64,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" alt="logo"/><span>老古董</span></a><div class="header__menu "><span></span><span></span><span></span></div><nav class="header__nav "><ul><li><a href="/blog/">博客 💻</a></li><li><a href="/tag/">标签 📌</a></li><li><a href="/lab/">实验室 📐</a></li><li><a href="/share/">分享 📝</a></li><li><a href="/about/">我 👻</a></li></ul></nav></div></header><main class="__content"><div class="xyd-content"><div><a style="display:block;text-decoration:none;color:#fff;margin-bottom:20px" href="/blog/">« 返回博客列表 🚗</a><h1>写一个 webpack 怎么样 ❓❔❓❔</h1><p style="font-size:20px">07 May, 2019</p><div style="width:100%;margin-bottom:20px"><img alt="laogudong" src="/static/webpack-362a5f580df72a6b4064d0c7d6b91811.jpg" style="width:100%"/></div><div><p><strong>鲁迅说: 当我们会用一样东西的时候，就要适当地去了解一下这个东西是怎么运转的。</strong></p>
<hr>
<h2>一. 什么是Webpack</h2>
<ul>
<li><a href="https://www.webpackjs.com/">webpack的介绍</a></li>
</ul>
<h2>二. 写一个简单的Webpack</h2>
<h3>1. 看一下Webpack的流程图</h3>
<p><a href="http://119.23.54.204/static/xyd_image/global/webpack.jpg"><img src="http://119.23.54.204/static/xyd_image/global/webpack.jpg"></a></p>
<p>当然我不可能实现全部功能, 因为能力有限, 我只挑几个重要的实现</p>
<h3>2. 准备工作</h3>
<p>创建两个项目, 一个为项目<code class="language-text">juejin-webpack</code>, 一个为我们自己写的打包工具, 名字为<code class="language-text">xydpack</code></p>
<p>1)<code class="language-text">juejin-webpack</code>项目主入口文件内容和打包配置内容为 :</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode <span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    entry <span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'src/app.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    output <span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path <span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename <span class="token punctuation">:</span> <span class="token string">'bundle.js'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// app.js</span>

<span class="token comment">/* 
    // moduleA.js
        let name = 'xuyede'
        module.exports = name
*/</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./js/moduleA.js'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> oH1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span>
oH1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello '</span> <span class="token operator">+</span> name
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>oH1<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>2)为了方便调试，我们需要把自己的<code class="language-text">xydpack</code>包<code class="language-text">link</code>到本地, 然后引入到<code class="language-text">juejin-webpack</code>中, 具体操作如下</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// 1. 在xydpack项目的 package.json文件中加上 bin属性, 并配置对应的命令和执行文件</span>
<span class="token punctuation">{</span>
  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"xydpack"</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string">"main"</span><span class="token punctuation">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string">"license"</span><span class="token punctuation">:</span> <span class="token string">"MIT"</span><span class="token punctuation">,</span>
  <span class="token string">"bin"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"xydpack"</span> <span class="token punctuation">:</span> <span class="token string">"./bin/xydpack.js"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. 在xydpack项目中添加相应路径的xydpack.js文件, 并在顶部加上该文件的运行方式</span>
#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is xydpack'</span><span class="token punctuation">)</span>

<span class="token comment">// 3. 在 xydpack项目的命令行上输入 npm link</span>

<span class="token comment">// 4. 在 juejin-webpack项目的命令行上输入 npm link xydpack</span>

<span class="token comment">// 5. 在 juejin-webpack项目的命令行上输入 npx xydpack后, 会输出 this is xydpack 就成功了</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h3>3. 编写 xydpack.js</h3>
<p>从第一步的流程图中我们可以看出, <code class="language-text">webpack</code>打包文件的第一步是获取打包配置文件的内容, 然后去实例化一个<code class="language-text">Compiler</code>类, 再通过<code class="language-text">run</code>去开启编译, 所以我可以把<code class="language-text">xydpack.js</code>修改为</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/compiler.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>然后去编写<code class="language-text">compiler.js</code>的内容</p>
<p>ps : 编写<code class="language-text">xydpack</code>可以通过在<code class="language-text">juejin-webpack</code>项目中使用<code class="language-text">npx xydpack</code> 去调试</p>
<h3>4. 编写 compiler.js</h3>
<h5>1. Compiler</h5>
<p>根据上面的调用我们可以知道, <code class="language-text">Compiler</code>为一个类, 并且有<code class="language-text">run</code>方法去开启编译</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config
    <span class="token punctuation">}</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h5>2. buildModule</h5>
<p>在流程图中有一个<code class="language-text">buildModule</code>的方法去实现构建模块的依赖和获取主入口的路径, 所以我们也加上这个方法</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> config
        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// modulePath : 模块路径 (绝对路径)</span>
        <span class="token comment">// isEntry : 是否是主入口</span>
    <span class="token punctuation">}</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>在<code class="language-text">buildModule</code>方法中, 我们需要从主入口出发, 分别获取模块的路径以及对应的代码块, 并把代码块中的<code class="language-text">require</code>方法改为<code class="language-text">__webpack_require__</code>方法</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> content
    <span class="token punctuation">}</span>
    <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 模块的源代码</span>
        <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
        <span class="token comment">// 模块的路径</span>
        <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> moduleName
    <span class="token punctuation">}</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h5>3. parse</h5>
<p>得到模块的源码后, 需要去解析,替换源码和获取模块的依赖项, 所以添加一个<code class="language-text">parse</code>方法去操作, 而解析代码需要以下两个步骤 :</p>
<ol>
<li>
<p>使用AST抽象语法树去解析源码</p>
</li>
<li>
<p>需要几个包辅助</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">@babel/parser -&gt; 把源码生成AST
@babel/traverse -&gt; 遍历AST的结点
@babel/types -&gt; 替换AST的内容
@babel/generator -&gt; 根据AST生成新的源码</code></pre></div>
<p>注意 : <code class="language-text">@babel/traverse</code>和<code class="language-text">@babel/generator</code>是<code class="language-text">ES6</code>的包, 需要使用<code class="language-text">default</code>导出</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
  <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
  <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生成AST</span>
      <span class="token keyword">let</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
      <span class="token comment">// 遍历AST结点</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 生成新的代码</span>
      <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code
  <span class="token punctuation">}</span>
  <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
      <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> moduleName

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>那么得到的<code class="language-text">ast</code>是什么呢, 大家可以去👇 <a href="https://astexplorer.net/">AST Explorer</a> 查看代码解析成<code class="language-text">ast</code>后是什么样子。</p>
</li>
</ol>
<p>当有函数调用的语句类似<code class="language-text">require()/ document.createElement()/ document.body.appendChild()</code>, 会有一个<code class="language-text">CallExpression</code>的属性保存这些信息,  所以接下来要干的事为 : </p>
<ul>
<li>
<p>代码中需要改的函数调用是<code class="language-text">require</code>, 所以要做一层判断</p>
</li>
<li>
<p>引用的模块路径加上主模块<code class="language-text">path</code>的目录名</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
  <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
  <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 生成AST</span>
      <span class="token keyword">let</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
      <span class="token comment">// 模块依赖项列表</span>
      <span class="token keyword">let</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment">// 遍历AST结点</span>
      <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function">CallExpression</span> <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">const</span> node <span class="token operator">=</span> p<span class="token punctuation">.</span>node
              <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// 函数名替换</span>
                  node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'__webpack_require__'</span>
                  <span class="token comment">// 路径替换</span>
                  <span class="token keyword">let</span> modulePath <span class="token operator">=</span> node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
                  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token comment">// require('./js/moduleA')</span>
                      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`没有找到文件 : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> , 检查是否加上正确的文件后缀`</span></span><span class="token punctuation">)</span>
                  <span class="token punctuation">}</span>
                  modulePath <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
                  node<span class="token punctuation">.</span>arguments <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">]</span>
                  <span class="token comment">// 保存模块依赖项</span>
                  dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 生成新的代码</span>
      <span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code
      <span class="token keyword">return</span> <span class="token punctuation">{</span> 
          sourceCode<span class="token punctuation">,</span> dependencies
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
      <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> moduleName

      <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependencies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>递归获取所有的模块依赖, 并保存所有的路径与依赖的模块</p>
</li>
</ul>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span>
        <span class="token keyword">let</span> moduleName <span class="token operator">=</span> <span class="token string">'./'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\\/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEntry<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> moduleName

        <span class="token keyword">let</span> <span class="token punctuation">{</span> sourceCode<span class="token punctuation">,</span> dependencies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">)</span>

        dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">d</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h5>4. emit</h5>
<p>在获取了所有的模块依赖关系和主入口后, 接下来要把数据插入模板并写入配置项中的<code class="language-text">output.path</code></p>
<p>因为需要一个模板, 所以借用一下<code class="language-text">webpack</code>的模板, 使用<code class="language-text">EJS</code>去生成模板, 不了解<code class="language-text">EJS</code>的点 👇 <a href="https://ejs.bootcss.com/">这里</a> 模板的内容为 : </p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// lib/template.ejs</span>

<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  
      <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        i<span class="token punctuation">:</span> moduleId<span class="token punctuation">,</span>
        l<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        exports<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
      module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">"&lt;%-entryPath%>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">%</span><span class="token operator">></span>
        <span class="token string">"&lt;%-key%>"</span><span class="token punctuation">:</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">eval</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span>modules<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">%</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>下面我们编写<code class="language-text">emit</code>函数</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">emit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> modules<span class="token punctuation">,</span> entryPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">const</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template.ejs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> modules<span class="token punctuation">,</span> entryPath <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">code</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> entry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>如果写到这, 在<code class="language-text">juejin-webpack</code>项目里输入<code class="language-text">npx xydpack</code>就会生成一个<code class="language-text">dist</code>目录, 里面有一个<code class="language-text">bundle.js</code>文件, 可运行在浏览器中👇 <a href="https://codepen.io/xuyede/pen/eamQJd">演示</a></p>
<h2>三. 加上 loader</h2>
<p>经过二之后, 只是单纯地转了一下代码, 好像没啥意义~</p>
<p>所以我们要加上<code class="language-text">loader</code>, 对<code class="language-text">loader</code>不熟悉的点👇 <a href="https://www.webpackjs.com/contribute/writing-a-loader/">这里</a> 因为是手写嘛, 所以我们<code class="language-text">loader</code>也自己写一下</p>
<p>注意 : 因为这个东西相当简易, 所以只能玩一下样式的<code class="language-text">loader</code>, 其他的玩不了,   所以只演示写一下样式的<code class="language-text">loader</code></p>
<h4>1. 样式的loader</h4>
<p>我个人习惯使用<code class="language-text">stylus</code>去编写样式, 所以样式就写<code class="language-text">stylus-loader</code>和<code class="language-text">style-loader</code></p>
<p>首先, 在配置项上加上<code class="language-text">loader</code>, 然后在<code class="language-text">app.js</code>中引入<code class="language-text">init.styl</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> root <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode <span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    entry <span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'src/app.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    output <span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path <span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename <span class="token punctuation">:</span> <span class="token string">'bundle.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module <span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules <span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test <span class="token punctuation">:</span> <span class="token regex">/\.styl(us)?$/</span><span class="token punctuation">,</span>
                use <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">,</span> <span class="token string">'style-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">,</span> <span class="token string">'stylus-loader.js'</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> config
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// app.js</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./js/moduleA.js'</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./style/init.styl'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> oH1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span>
oH1<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello '</span> <span class="token operator">+</span> name
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>oH1<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>在根目录创建一个<code class="language-text">loaders</code>目录去编写我们的<code class="language-text">loader</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// stylus-loader</span>

<span class="token keyword">const</span> stylus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stylus'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">loader</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> css <span class="token operator">=</span> <span class="token string">''</span>
    stylus<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            css <span class="token operator">=</span> data
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> css
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// style-loader</span>

<span class="token keyword">function</span> <span class="token function">loader</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        let style = document.createElement('style')
        style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        document.body.appendChild(style)
    `</span></span>
    <span class="token keyword">return</span> script
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">loader</code>是在读取文件的时候进行操作的, 因此修改<code class="language-text">compiler.js</code>, 在<code class="language-text">getSource</code>函数加上对应的操作</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
<span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">getSource</span> <span class="token punctuation">(</span><span class="token parameter">modulePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> rules <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules
            <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> <span class="token punctuation">{</span> test<span class="token punctuation">,</span> use <span class="token punctuation">}</span> <span class="token operator">=</span> rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token keyword">let</span> len <span class="token operator">=</span> use<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 递归处理所有loader</span>
                    <span class="token keyword">function</span> <span class="token function">loopLoader</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> loader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>use<span class="token punctuation">[</span>len<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        content <span class="token operator">=</span> <span class="token function">loader</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">loopLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> content
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`获取数据错误 : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modulePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">buildModule</span> <span class="token punctuation">(</span><span class="token parameter">modulePath<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">emit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Compiler</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>然后运行<code class="language-text">npx xydpack</code>打包, 会添加一段这样的代码</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token string">"./src/style/init.styl"</span><span class="token punctuation">:</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"let style = document.createElement('style');\nstyle.innerHTML = \"* {\\n  padding: 0;\\n  margin: 0;\\n}\\nbody {\\n  color: #f40;\\n}\\n\";\ndocument.head.appendChild(style);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<p>然后运行就可以了, <a href="https://codepen.io/xuyede/pen/EzaOjW">演示</a></p>
<h4>*2. 脚本的loader</h4>
<p>脚本的<code class="language-text">loader</code>, 第一个想到的就是<code class="language-text">babel-loader</code>, 我们自己写一个<code class="language-text">babel-loader</code>, 但是需要使用<code class="language-text">webpack</code>去打包, 修改配置文件为</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>

resolveLoader <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    modules <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
module <span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules <span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            test <span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
            use <span class="token punctuation">:</span> <span class="token punctuation">{</span>
                loader <span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                options <span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    presets <span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        <span class="token string">'@babel/preset-env'</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>使用<code class="language-text">babel</code>需要三个包: <code class="language-text">@babel/core | @babel/preset-env | loader-utils</code>安装后, 然后编写<code class="language-text">babel-loader</code></p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber 0" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">loader</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span> 
        <span class="token operator">...</span>options<span class="token punctuation">,</span>
        sourceMap <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        filename <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// 错误, 返回的值, sourceMap的内容</span>
        <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>然后使用<code class="language-text">webpack</code>打包就行了</p>
<h2>四. 总结</h2>
<p>到这里, 我们就可以大概猜一下<code class="language-text">webpack</code>的运作流程是这样的 :</p>
<ol>
<li>获取配置参数</li>
<li>实例化Compiler, 通过run方法开启编译</li>
<li>根据入口文件, 创建依赖项, 并递归获取所有模块的依赖模块</li>
<li>通过loader去解析匹配到的模块</li>
<li>获取模板, 把解析好的数据套进不同的模板</li>
<li>输出文件到指定路径</li>
</ol>
<p>注意 : 我这个只是自己闹着玩的, 要学<code class="language-text">webpack</code>, 点 <a href="https://www.webpackjs.com/">这里</a> </p></div></div></div></main><div class="back2Top"></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2019/05/07/rewrite-a-webpack/";window.webpackCompilationHash="350ee6c45702aaa5c19a";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-a702b083f54a54c055ec.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-7d9641c02123281eb66f.js"],"component---src-pages-404-js":["/component---src-pages-404-js-10e1c60d058fe5bfed2d.js"],"component---src-pages-about-js":["/component---src-pages-about-js-3872249a23086c9ab1dc.js"],"component---src-pages-blog-index-js":["/component---src-pages-blog-index-js-e7325b4e443a36f6836d.js"],"component---src-pages-index-js":["/component---src-pages-index-js-1189d1fe093bc79a23b4.js"],"component---src-pages-lab-index-js":["/component---src-pages-lab-index-js-47b84f9d4680fea6cb7b.js"],"component---src-pages-share-js":["/component---src-pages-share-js-d6410cd548f5769057e7.js"],"component---src-pages-tag-js":["/component---src-pages-tag-js-d7450255ec908dd75f90.js"]};/*]]>*/</script><script src="/webpack-runtime-0b572f9ac9ad8fc9d343.js" async=""></script><script src="/styles-3707068c25adbcad7d92.js" async=""></script><script src="/app-a702b083f54a54c055ec.js" async=""></script><script src="/1-1708d7373d1b726d8c3a.js" async=""></script><script src="/component---src-templates-blog-post-js-7d9641c02123281eb66f.js" async=""></script></body></html>